version: '3'

services:
  base: &base
    image: chatwoot/chatwoot:latest
    env_file: .env ## Change this file for customized env variables
    volumes:
      - storage_data:/app/storage

rails:
    <<: *base
    depends_on: []
    ports:
      - '127.0.0.1:3000:3000'
    environment:
      - NODE_ENV=production
      - RAILS_ENV=production
      - INSTALLATION_ENV=docker
      # PostgreSQL externo
      - POSTGRES_HOST=ballast.proxy.rlwy.net
      - POSTGRES_PORT=32157
      - POSTGRES_DATABASE=railway
      - POSTGRES_USERNAME=postgres
      - POSTGRES_PASSWORD=IEvvWtAddhBRIUeRtPIErTmaElgFuxnO
      # Redis externo
      - REDIS_URL=redis://:wOhQHN0Kn2cr8t_Bt91Z7q3CW-K_iqrt@switchback.proxy.rlwy.net:54303/0
      - SECRET_KEY_BASE=a655632d5ea9484259dd97d3afc5bf41e80f81b3ec20c87e8106587b3758fa63a21ab2e77ebd420dc2ce187cdc9beecce7c50521be0ff7f323190d1b80053881
    entrypoint: docker/entrypoints/rails.sh
    command: ['bundle', 'exec', 'rails', 's', '-p', '3000', '-b', '0.0.0.0']
    restart: always

  sidekiq:
    <<: *base
    depends_on: []
    environment:
      - NODE_ENV=production
      - RAILS_ENV=production
      - INSTALLATION_ENV=docker
      # PostgreSQL externo
      - POSTGRES_HOST=ballast.proxy.rlwy.net
      - POSTGRES_PORT=32157
      - POSTGRES_DATABASE=railway
      - POSTGRES_USERNAME=postgres
      - POSTGRES_PASSWORD=IEvvWtAddhBRIUeRtPIErTmaElgFuxnO
      # Redis externo
      - REDIS_URL=redis://:wOhQHN0Kn2cr8t_Bt91Z7q3CW-K_iqrt@switchback.proxy.rlwy.net:54303/0
      - SECRET_KEY_BASE=a655632d5ea9484259dd97d3afc5bf41e80f81b3ec20c87e8106587b3758fa63a21ab2e77ebd420dc2ce187cdc9beecce7c50521be0ff7f323190d1b80053881
    command: ['bundle', 'exec', 'sidekiq', '-C', 'config/sidekiq.yml']
    restart: always

volumes:
  storage_data:
